clc
clear all
close all

pkg load control


x = [ 301.5, 298.23, 297.83, 300.42, 301.94, 299.5, 305.98, ...
301.25, 299.73, 299.2, 298.62, 301.84, 299.6, 295.3, 299.3, ...
301.95, 296.3, 295.11, 295.12, 289.9, 283.51, 276.42, 264.22, ...
250.25, 236.66, 217.47, 199.75, 179.7, 160, 140.92, 113.53, ...
93.68, 69.71, 45.93, 20.87];

y = [-401.46, -375.44, -346.15, -320.2, -300.08, -274.12, -253.45, ...
-226.4, -200.65, -171.62, -152.11, -125.19, -93.4, -74.79, -49.12, ...
-28.73, 2.99, 25.65, 49.86, 72.87, 96.34, 120.4, 144.69, ...
168.06, 184.99, 205.11, 221.82, 238.3, 253.02, 267.19, 270.71, ...
285.86, 288.48, 292.9, 298.77];


dt = 1;

sigma_a = 0.2; %m/s^2
sigma_x_m = 4; %m
sigma_y_m = sigma_x_m;


F = [1, dt, 0.5*dt^2, 0, 0, 0; ...
0, 1, dt, 0, 0, 0; ...
0, 0, 1, 0, 0, 0; ...
0, 0, 0, 1, dt, 0.5*dt^2; ...
0, 0, 0, 0, 1, dt; ...
0, 0, 0, 0, 0, 1];


Q = [
dt^4/4, dt^3/2, dt^2/2, 0, 0, 0; ...
dt^3/2, dt^2, dt, 0, 0, 0; ...
dt^2/2, dt, 1, 0, 0, 0; ...
0, 0, 0, dt^4/4, dt^3/2, dt^2/2; ...
0, 0, 0, dt^3/2, dt^2, dt; ...
0, 0, 0, dt^2/2, dt, 1]*sigma_a^2;

R = diag([sigma_x_m^2, sigma_y_m^2]);

H = [1, 0, 0, 0, 0, 0; ...
0, 0, 0, 1, 0, 0];

I = eye(6);


x_00 = [0; 0; 0; 0; 0; 0];
P_00 = diag([500, 500, 500, 500, 500, 500]);

x_n = F*x_00
P_n = F*P_00*F' + Q

est_x = zeros(1, length(x));
est_y = zeros(1, length(y));

% kalman filter
for i = 1:length(x)

  % measurement
  z = [x(i); y(i)]

  % update
  K = P_n*H'*inv(H*P_n*H' + R)
  x_n = x_n + K*(z - H*x_n)
  P_n = (I - K*H)*P_n*(I - K*H)' + K*R*K'

  est_x(i) = x_n(1);
  est_y(i) = x_n(4);

  % prediction
  x_n = F*x_n
  P_n = F*P_n*F' + Q


end



figure;
plot(x, y, '-x')
hold on
plot(est_x, est_y, '-o')
xlabel("x position [m]")
ylabel("y position [m]")
grid on

